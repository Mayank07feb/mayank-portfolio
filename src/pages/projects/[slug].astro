---
import Layout from "../../layouts/Layout.astro";
import ProjectDetail from "../../components/ProjectDetails";
import { API_BASE_URL } from "../../config/api";

export const prerender = false;

const { slug } = Astro.params;

const res = await fetch(
  `${API_BASE_URL}/api/categories/project-categories/${slug}`,
  { cache: "no-store" }
);

if (!res.ok) return Astro.redirect("/404");

const data = await res.json();

if (!data.success || !data.category) {
  return Astro.redirect("/404");
}

// ✅ PURE API → UI MAPPING (NO STATIC DATA)
const project = {
  id: data.category.id,
  title: data.category.name,
  slug: data.category.slug,
  category: data.category.name,
  description: data.category.description || null,

  meta_title: data.category.meta_title || null,
  meta_description: data.category.meta_description || null,

  hero: {
    // Use thumbnail_url for hero image
    image: data.category.media?.thumbnail_url || data.category.media?.media_name || '/placeholder.jpg',
    alt: data.category.name || null,
  },

  categories: data.category.name ? [data.category.name] : [],

  story: [
    ...(data.category.description ? [data.category.description] : []),
    ...(data.projects?.map(p => p.description).filter(Boolean) || []),
  ],

  details: {
    client: data.projects?.[0]?.name || null,
    year: data.projects?.[0]?.created_at_utc
      ? new Date(data.projects[0].created_at_utc).getFullYear()
      : null,
    services: data.projects?.[0]?.role || null,
    location: null,
  },

  quote: null,

  // ✅ GALLERY: Use media_url for gallery images (no base path)
  gallery: [
    ...new Map(
      (data.projects || []).flatMap(p =>
        (p.media || []).map(m => [
          m.media_url,
          {
            image: m.media_url,
            largeImage: m.media_url,
            alt: p.name || m.media_name || null,
            caption: p.name || null,
          }
        ])
      )
    ).values()
  ],
};

// ✅ SEO ONLY FROM API
const pageTitle = project.meta_title;
const pageDescription = project.meta_description;
---

<Layout
  title={pageTitle}
  description={pageDescription}
  currentPage="projects"
>
  <ProjectDetail project={project} client:load />
</Layout>